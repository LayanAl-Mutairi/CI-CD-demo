stages:
  - build
  - test
  - performance
  - tag_release 
  - release
  

variables:
  IMAGE_NAME: email-validator:1.0
  REGISTRY: $CI_REGISTRY_IMAGE
  TAG: $CI_COMMIT_SHORT_SHA

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $REGISTRY:$CI_COMMIT_SHA
    - docker save $IMAGE_NAME -o docker-image.tar
  artifacts:
    paths:
      - docker-image.tar

integration_test:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - build
  script:
    - docker load -i docker-image.tar
    - >
      docker run --rm -p 5000:5000 $IMAGE_NAME /bin/sh -c "
      python app.py & 
      sleep 5 && 
      pytest tests/integration/"
  artifacts:
    when: always
    reports:
      junit: tests/integration/report.xml

uat_test:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - build
  script:
    - docker load -i docker-image.tar
    - >
      docker run --rm -p 5000:5000 $IMAGE_NAME /bin/sh -c "
      python app.py & 
      sleep 15 && 
      pytest tests/uat/"
  artifacts:
    when: always
    reports:
      junit: tests/uat/report.xml

performance_test:
  stage: performance
  image: openjdk:11
  script:
    - apt-get update && apt-get install -y wget unzip curl
    - wget https://repo1.maven.org/maven2/io/gatling/highcharts/gatling-charts-highcharts-bundle/3.9.5/gatling-charts-highcharts-bundle-3.9.5-bundle.zip
    - unzip gatling-charts-highcharts-bundle-3.9.5-bundle.zip
    - cp gatling/simulations/BasicSimulation.scala gatling-charts-highcharts-bundle-3.9.5/user-files/simulations/
    - echo "1" | ./gatling-charts-highcharts-bundle-3.9.5/bin/gatling.sh -s simulations.BasicSimulation

tag_release:
  stage: tag_release
  dependencies:
    - integration_test
    - uat_test
    - performance_test
  script:
    - git config --global user.email "ci-bot@example.com"
    - git config --global user.name "CI Bot"
    - export NEW_TAG="v$(date +%Y%m%d%H%M%S)"
    - git tag $NEW_TAG
    - git push origin $NEW_TAG
  only:
    - main
  when: on_success


release:
  stage: release
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker load -i docker-image.tar
    - docker tag $IMAGE_NAME $REGISTRY:$TAG
    - echo $CI_JOB_TOKEN | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker push $REGISTRY:$TAG
  only:
    - tags
